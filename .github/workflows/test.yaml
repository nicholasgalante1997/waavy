name: Tests

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  check-types:
    name: Check Types
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Bun Runtime
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Check types
        run: bun run check-types
        continue-on-error: true
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Bun Runtime
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Run tests
        run: bun test
        continue-on-error: true
  test-linux-sh:
    name: Test Linux Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Bun Runtime
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Build
        run: bun run build
        env:
          NODE_ENV: production
        continue-on-error: true
      - name: Make linux render shell script executable
        run: chmod +x ./test/commands/render.linux.sh

      - name: Run shell scripts
        run: ./test/commands/render.linux.sh
  summary:
    name: Pipeline Summary
    needs:
      - check-types
      - test
      - test-linux-sh
    runs-on: ubuntu-latest
    if: always() # Run regardless of previous job status
    steps:
      - name: Print summary
        run: |
          echo "ğŸ“ Pipeline Summary:"

          if [[ "${{ needs.test.result }}" == "success" && "${{ needs.check-types.result }}" == "success" && "${{ needs.test-linux-sh.result }}" == "success" ]]; then
              echo "âœ… All jobs succeeded!"
          else
              echo "âŒ One or more jobs failed."
              echo "ğŸ” check-types: ${{ needs.check-types.result }}"
              echo "ğŸ” test: ${{ needs.test.result }}"
              echo "ğŸ” test_linux_shell_commands: ${{ needs.test-linux-sh.result }}"
              exit 1
          fi
